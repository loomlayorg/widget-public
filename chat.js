(()=>{class e extends HTMLElement{constructor(){super(),this.shadow=this.attachShadow({mode:"open"}),this.cdnUrl="https://cdn.jsdelivr.net/gh/loomlayorg/widget-public@main",this._initConfig(),this.isExtraLoggingEnabled=!0,this.agentList=[],this.isSettingsEnabled=!1,this.isPipActive=!1,this.isPipRequestInProgress=!1,this.waitingMessagesTimers=[],this.automaticMessagesConfig=this._getDefaultAutomaticMessagesConfig(),this.isChatOpen=!0,this.initialMessage="",this.greetingMessage="",this.extraParams="",this.highlightedElement=null,this.isStopAllRequested=!1}_initConfig(){this.config={apiEndpoint:"https://api.loomlay.com/api:sDfF41c6/conversation/create",authToken:"some_token",agentUUID:"01876f7a09b24a43b76fe0fcd4daeee5",accessKey:null,chatTitle:"Loomlay Chat",closeButtonColor:"#2773747",sendButtonColor:"#2773747",sendButtonBg:"linear-gradient(90deg, #B3FFD8, #DCC8FF, #AEE2FF)",switchButtonColor:"#2773747",headerColor:"#2773747",headerTextColor:"white",headerBg:"linear-gradient(90deg, #B3FFD8, #DCC8FF, #AEE2FF)",footerColor:"#2773747",borderRadius:"20px",bodyColor:"#2773747",messageInputColor:"#2773747",openChatButtonBg:"#2773747",extraContext:null,contextMemory:"",autoResponse:!1,openWidgetIconUrl:this.cdnUrl+"/images/chat_button.svg",logoIconUrl:this.cdnUrl+"/images/logo.svg",cleanIconUrl:this.cdnUrl+"/images/tabler_refresh.svg",popOutIcon:this.cdnUrl+"/images/open_new_window.svg",closeIcon:this.cdnUrl+"/images/close.svg",sendButtonImg:this.cdnUrl+"/images/chat_input.svg"},this.requestBody={agent_uuid:this.config.agentUUID,context:null,extra_context:null,continue:!0,key:null,extra_params:null}}_loadScript(o){return new Promise((e,t)=>{var s=document.createElement("script");s.src=o,s.onload=e,s.onerror=t,this.shadow.appendChild(s)})}_getDefaultAutomaticMessagesConfig(){return[{message:"request received",timeout:5e3},{message:"analyzing the data...",timeout:1e4},{message:"preparing the answer...",timeout:2e4}]}_setupEvents(){this.chatMessages?(console.log("Attaching click events to:",this.chatMessages),this.chatMessages.addEventListener("click",e=>{var t,s,o=e.target.closest(".replybutton, .replylink, .instruction-button");o&&(e.preventDefault(),o.classList.contains("instruction-button")?(console.log("Instruction button clicked!"),this._executeInstructions(o)):(t=o.getAttribute("data-action"),s=o.getAttribute("data-url"),o=o.getAttribute("data-context"),"open-current"===t?s&&(window.location.href=s):"open-new"===t?s&&window.open(s,"_blank"):"prompt"===t?o&&this._sendMessage(o):o&&(console.log("Delegated Click (Normal Mode) - Context:",o),"function"==typeof this._sendStartMessage?this._sendStartMessage(o,e):console.error("_sendStartMessage is not defined."))))}),this.messageInput.addEventListener("keydown",this._handleEnterKey.bind(this)),this.closeChatButton.addEventListener("click",this.closeChat.bind(this)),this.popOutChatButton.addEventListener("click",this._handlePopout.bind(this)),this.clearChatButton.addEventListener("click",this._clearChatCache.bind(this)),this.openChatButton.addEventListener("click",this._openChat.bind(this)),this.sendButton.addEventListener("click",()=>this._sendMessage()),this.isSettingsEnabled&&this.settingsButton&&this.agentDropdownContainer&&this.settingsButton.addEventListener("click",this._toggleAgentDropdown.bind(this)),this.isSettingsEnabled&&this.agentDropdown&&(this._populateAgentDropdown(),this.agentDropdown.addEventListener("change",this._handleAgentChange.bind(this))),this.stopAllButton&&this.stopAllButton.addEventListener("click",this._handleStopAll.bind(this))):console.error("Chat messages container not found.")}connectedCallback(){this._replaceActions(),this._loadConfigFromDomAttributes(),this._loadAutomaticMessages(),this._loadExtraContext(),this._loadExtraParams(),this._loadAuthToken(),this._processAgents(),this._updateRequestContext(),this._render(),this._setupEvents(),this._loadConversationCache(),this._setInitialState(),this._scrollToChatBottom(),this._resumeAllInstructions(),this.isStopAllRequested=!1,this.stopAllButton.style.display="none",this._setupMutationObserver()}_setupMutationObserver(){var e,t=document.querySelector("body");t?((e=new MutationObserver((e,t)=>{for(var s of e)if("childList"===s.type){console.log("DOM content changed, re-running _replaceActions"),this._replaceActions();break}})).observe(t,{childList:!0,subtree:!0}),console.log("MutationObserver started, watching for DOM changes."),this._mutationObserver=e):console.warn("MutationObserver target node 'body' not found. MutationObserver setup failed.")}disconnectedCallback(){this._mutationObserver&&(this._mutationObserver.disconnect(),console.log("MutationObserver disconnected."),this._mutationObserver=null)}_loadConfigFromDomAttributes(){this.config.chatTitle=this.getAttribute("chat-title")||this.config.chatTitle,this.config.borderRadius=this.getAttribute("radius")||this.config.borderRadius,this.config.closeButtonColor=this.getAttribute("closeButtonColour")||this.config.closeButtonColor,this.config.sendButtonColor=this.getAttribute("sendButtonColor")||this.config.sendButtonColor,this.config.sendButtonBg=this.getAttribute("sendButtonBg")||this.config.sendButtonBg,this.config.switchButtonColor=this.getAttribute("switchButtonColor")||this.config.switchButtonColor,this.config.headerColor=this.getAttribute("headerColor")||this.config.headerColor,this.config.headerTextColor=this.getAttribute("headerTextColor")||this.config.headerTextColor,this.config.headerBg=this.getAttribute("headerBg")||this.config.headerBg,this.config.footerColor=this.getAttribute("footerColor")||this.config.footerColor,this.config.bodyColor=this.getAttribute("bodyColor")||this.config.bodyColor,this.config.messageInputColor=this.getAttribute("messageInputColor")||this.config.messageInputColor,this.config.openChatButtonBg=this.getAttribute("open-btn-bg")||this.config.openChatButtonBg,this.config.autoResponse="true"===this.getAttribute("auto-response")||this.config.autoResponse,this.isChatOpen="true"===this.getAttribute("isOpen")||this.config.isOpen,this.initialMessage=this.getAttribute("initial-message")||this.initialMessage,this.greetingMessage=this.getAttribute("greeting-message")||this.greetingMessage,this.config.contextMemory=this.getAttribute("context")||this.config.contextMemory,this.config.openWidgetIconUrl=this.getAttribute("open-icon")||this.config.openWidgetIconUrl,this.config.logoIconUrl=this.getAttribute("chat-logo")||this.config.logoIconUrl,this.config.cleanIconUrl=this.getAttribute("clean-icon")||this.config.cleanIconUrl,this.config.popOutIcon=this.getAttribute("pop-out-icon")||this.config.popOutIcon,this.config.sendButtonImg=this.getAttribute("send-icon")||this.config.sendButtonImg,this.config.closeIcon=this.getAttribute("close-icon")||this.config.closeIcon}_loadAutomaticMessages(){var e=this.querySelector("automaticResponseMessages");e&&0<(e=e.querySelectorAll("message")).length&&(this.automaticMessagesConfig=Array.from(e).map(e=>{var t=parseInt(e.getAttribute("timeout"),10);return{message:e.textContent,timeout:isNaN(t)?0:t}}))}_loadExtraContext(){var e=this.querySelector("userContext");this.config.extraContext=e?.innerHTML||this.config.extraContext}_loadExtraParams(){var e=this.querySelector("extraParams");try{this.extraParams=e?.innerHTML?JSON.parse(e.innerHTML):this.config.extra_params}catch(e){console.error("Error parsing extraParams JSON:",e),this.extraParams=this.config.extra_params}}_loadAuthToken(){this.authToken=this.getAttribute("accesskey"),this.authToken&&(this.config.authToken=this.authToken)}_processAgents(){var e=this.querySelector("agents"),e=e?Array.from(e.querySelectorAll("agent")):[];this.isSettingsEnabled=1<e.length,0<e.length&&(this._loadAgentList(e),this._initAgentSelection())}_loadAgentList(e){this.agentList=e.map(e=>({agent_uuid:e.getAttribute("uuid"),agent_name:e.getAttribute("name"),agent_description:e.getAttribute("description")})).filter(e=>e.agent_uuid&&e.agent_name)}_initAgentSelection(){var e=localStorage.getItem("selectedAgent");e?this.config.agentUUID=e:0<this.agentList.length&&(this.config.agentUUID=this.agentList[0].agent_uuid),this.requestBody.agent_uuid=this.config.agentUUID}_updateRequestContext(){this.requestBody.extra_context=this.config.extraContext,this.requestBody.extra_params=this.extraParams}_scrollToChatBottom(){this.chatMessages&&this.chatMessages.scrollTo({top:this.chatMessages.scrollHeight,behavior:"smooth"})}_render(){var e=!("0"===this.config.contextMemory||"off"===this.config.contextMemory.toLowerCase()),t=this.config.contextMemory&&"select"===this.config.contextMemory.toLowerCase(),t=this._getHeaderRightItemsHtml(t?"block":"none",e?"checked":""),e=this.isSettingsEnabled?this._getAgentDropdownHtml():"",s=this.isPipActive?"0":this.config.borderRadius,o=document.querySelector('link[rel="stylesheet"][href*="chat.css"]').getAttribute("href");this.shadow.innerHTML=`
                <style>
                    @import url('${o}');
                    .chat-container {
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
                    }
                    .chat-container.pip-active-inline {
                        transform: translateY(100vh);
                        opacity: 0;
                        pointer-events: none;
                    }
                    .highlighted {
                        border: 2px solid red !important;
                        transition: border-color 0.5s ease-out;
                    }
                </style>
                <div id="chat-container" class="chat-container" style="border-radius: ${s}">
                    ${this._renderChatHeader(t,e)}
                    ${this._renderChatMessages()}
                    ${this._renderChatInput()}
                    <div id="cr"> Powered by <a target=”_blank” href="https://loomlay.com/"> loomlay</a></div>
                </div>

                ${this._getOpenChatButtonHtml()}
            `,this._cacheElements()}_renderChatHeader(e,t){return`
                <div id="chat-header" class="chat-header" style="background-color: ${this.config.headerColor};background: ${this.config.headerBg};color=${this.config.headerTextColor}">
                    <div class="header-title">
                        <img class="logo" src="${this.config.logoIconUrl}" alt="Logo">
                        <span>${this.config.chatTitle}</span>
                    </div>
                    <div id="header-right-items" class="header-right-items">
                        ${e}
                    </div>
                    ${t}
                </div>
            `}_renderChatMessages(){return`
                <div id="chat-messages" class="chat-messages" style="background-color: ${this.config.bodyColor}">
                    <div id="defaultbackground" class="default-background" >
                        <img src="${this.cdnUrl}/images/default.svg" alt="Default Background">
                        <br/><br/>
                    </div>
                </div>
            `}_renderChatInput(){return`
                <div id="chat-input" class="chat-input" style="background-color: ${this.config.footerColor}">
                    <input type="text" id="message-input" class="message-input" style="background-color: ${this.config.messageInputColor}" placeholder="Type your message...">
                    <button id="send-button" class="send-button" style="background-color: ${this.config.sendButtonColor};background: ${this.config.sendButtonBg}" aria-label="Send">
                        <img src="${this.config.sendButtonImg}" alt="Send">
                    </button>
                </div>
            `}_getHeaderRightItemsHtml(e,t){return`
         ${this._getStopAllButtonHtml()} 
                ${this._getMemoryCheckboxHtml(e,t)}
                ${this.isSettingsEnabled?this._getSettingsButtonHtml():""}
                ${this._getPopOutChatButtonHtml()}
                ${this._getClearChatButtonHtml()}
              
                ${this._getCloseChatButtonHtml()}
            `}_getStopAllButtonHtml(){return`<button id="stop-all-button" class="header-button" style="background-color: ${this.config.closeButtonColor}" aria-label="Stop All" title="Stop All Executions">
                        <img src="${this.cdnUrl}/images/stop.svg" >
                    </button>`}_getMemoryCheckboxHtml(e,t){return`
                <div class="memory-container" style="display: ${e};">
                    <input type="checkbox" id="continue-checkbox" class="memory-checkbox" style="background-color: ${this.config.switchButtonColor};" ${t} >
                    <label for="continue-checkbox" class="memory-checkbox-label">Context</label>
                </div>
            `}_getSettingsButtonHtml(){return`<button id="settings-button" class="header-button"  aria-label="Settings" title="Settings">
                        <img src="${this.cdnUrl}/images/settings.svg" >
                    </button>`}_getPopOutChatButtonHtml(){return`<button id="popout-chat-button" class="header-button" style="background-color: ${this.config.closeButtonColor};" aria-label="PopOut Chat" title="Pop Out Chat">
                        <img src="${this.config.popOutIcon}" >
                    </button>`}_getClearChatButtonHtml(){return`<button id="clear-chat-button" class="header-button" style="background-color: ${this.config.closeButtonColor}" aria-label="Clear Chat" title="Clear Chat">
                        <img src="${this.config.cleanIconUrl}" >
                    </button>`}_getCloseChatButtonHtml(){return`<button id="close-chat-button" class="header-button" style="background-color: ${this.config.closeButtonColor}; " aria-label="Close Chat" title="Close Chat">
                        <img src="${this.config.closeIcon}" >
                    </button>`}_getAgentDropdownHtml(){return`
                <div id="agent-dropdown-container" class="agent-dropdown-container">
                    <select class="mainselection" id="agent-dropdown">
                        <option value="" disabled selected>Select Agent</option>
                    </select>
                </div>
            `}_getOpenChatButtonHtml(){return`<button id="open-chat-button" class="open-chat-button" style="background: ${this.config.openChatButtonBg};">
                        <img class="open-chat-icon" src="${this.config.openWidgetIconUrl}" alt="Open Chat">
                    </button>`}_cacheElements(){this.chatContainer=this.shadow.querySelector("#chat-container"),this.chatHeader=this.shadow.querySelector("#chat-header"),this.chatMessages=this.shadow.querySelector("#chat-messages"),this.messageInput=this.shadow.querySelector("#message-input"),this.sendButton=this.shadow.querySelector("#send-button"),this.closeChatButton=this.shadow.querySelector("#close-chat-button"),this.clearChatButton=this.shadow.querySelector("#clear-chat-button"),this.popOutChatButton=this.shadow.querySelector("#popout-chat-button"),this.continueCheckbox=this.shadow.querySelector("#continue-checkbox"),this.openChatButton=this.shadow.querySelector("#open-chat-button"),this.settingsButton=this.shadow.querySelector("#settings-button"),this.agentDropdownContainer=this.shadow.querySelector("#agent-dropdown-container"),this.agentDropdown=this.shadow.querySelector("#agent-dropdown"),this.stopAllButton=this.shadow.querySelector("#stop-all-button")}_handleEnterKey(e){var t,s;"Enter"!==e.key||e.shiftKey?"Enter"===e.key&&e.shiftKey&&(e.preventDefault(),t=this.messageInput.selectionStart,s=this.messageInput.selectionEnd,this.messageInput.value=this.messageInput.value.substring(0,t)+"\n"+this.messageInput.value.substring(s),this.messageInput.selectionStart=this.messageInput.selectionEnd=t+1):(this._sendMessage(),e.preventDefault())}closeChat(){this.chatContainer.style.display="none",this.openChatButton.style.display="flex",this.agentDropdownContainer&&(this.agentDropdownContainer.style.display="none")}async _handlePopout(){"documentPictureInPicture"in window?await this._requestPictureInPicture():this._popout()}async _requestPictureInPicture(){if(!this.isPipRequestInProgress){this.isPipRequestInProgress=!0;let t=this.chatContainer.parentNode;try{this.isPipActive=!0,this.chatContainer.classList.add("pip-active-inline");this.shadow.querySelector("#chat-container");var e={width:380,height:502,lockAspectRatio:!0,copyStyleSheets:!0};let o=await documentPictureInPicture.requestWindow(e);[...document.styleSheets].forEach(t=>{try{var s=[...t.cssRules].map(e=>e.cssText).join(""),e=document.createElement("style");e.textContent=s,o.document.head.appendChild(e)}catch(e){s=document.createElement("link");s.rel="stylesheet",s.type=t.type,s.media=t.media,s.href=t.href,o.document.head.appendChild(s)}}),o.document.body.append(this.chatContainer),o.addEventListener("pagehide",e=>{this.isPipActive=!1,this.chatContainer.classList.remove("pip-active-inline"),t.appendChild(this.chatContainer),this.isPipRequestInProgress=!1,this._openChat()},{once:!0}),setTimeout(()=>{this._scrollToChatBottom()},100)}catch(e){console.error("Picture-in-Picture API error:",e),this._popout()}finally{this.isPipRequestInProgress=!1}}}_clearChatCache(){this._removeConversationCache(),this._clearAllInstructionStates()}_clearAllInstructionStates(){Object.keys(localStorage).forEach(e=>{e.startsWith("instructionState_")&&localStorage.removeItem(e)}),console.log("All instruction states cleared from localStorage.")}_handleStopAll(){console.log("Stop All button clicked."),this.isStopAllRequested=!0,this._clearWaitingMessages(),this._clearAllInstructionStates(),this._removeHighlight(),this._appendMessage("agent","All AI-Automated executions aborted.",!1)}_openChat(){console.log("Execute open chat"),this.chatContainer.style.display="flex",this.openChatButton.style.display="none";var e=JSON.parse(localStorage.getItem("cachedConversation_"+this.config.agentUUID));this.isChatOpen||!this.initialMessage||e||this.greetingMessage||this._sendMessage(this.initialMessage),setTimeout(()=>{this._scrollToChatBottom()},100)}_toggleAgentDropdown(){this.agentDropdownContainer.style.display="block"===this.agentDropdownContainer.style.display?"none":"block"}_handleAgentChange(e){e=e.target.value;this._selectAgent(e,!0)}_setInitialState(){this.isChatOpen||this.isPipActive?(this.chatContainer.style.display="flex",this.openChatButton.style.display="none",this._scrollToChatBottom()):(this.chatContainer.style.display="none",this.openChatButton.style.display="flex")}_popout(){window.open(window.location.href,"Agent Chat Popout","width=350,height=515,toolbar=0,location=0,menubar=0,status=0,scrollbars=0,resizable=0")}_selectAgent(e,t=!0){e&&(t&&localStorage.setItem("selectedAgent",e),this.config.agentUUID=e,this.requestBody.agent_uuid=e,this.chatMessages.innerHTML="",this.agentDropdownContainer.style.display="none",this._loadConversationCache())}_replaceActions(){var e=document.getElementsByTagName("loomlay-action");e&&Array.from(e).forEach(e=>{if(!e.innerHTML.includes("<button")&&!e.innerHTML.includes("<a")){var o=e.getAttribute("type"),n=e.getAttribute("text-color"),i=e.getAttribute("bg-color");let t=e.getAttribute("value");var a=e.innerHTML;let s;switch(o){case"btn":case"btn-synch":(s=document.createElement("button")).className="replybutton",s.innerHTML=a,s.addEventListener("click",e=>{console.log("Button Click - _sendStartMessage, value:",t,", event:",e),this._sendStartMessage(t,e)});break;case"btn-asynch":(s=document.createElement("button")).className="replybutton",s.innerHTML=a,s.addEventListener("click",e=>{console.log("Button Click - _sendAsyncStartMessage, value:",t,", event:",e),this._sendAsyncStartMessage(t,s,e)});break;case"link":case"link-synch":(s=document.createElement("span")).className="replylink",s.innerHTML=a,s.addEventListener("click",e=>{e.preventDefault(),console.log("Link Click - _sendStartMessage, value:",t,", event:",e),this._sendStartMessage(t,e)});break;case"link-asynch":(s=document.createElement("span")).className="replylink",s.innerHTML=a,s.addEventListener("click",e=>{e.preventDefault(),console.log("Link Click - _sendAsyncStartMessage, value:",t,", event:",e),this._sendAsyncStartMessage(t,s,e)});break;default:return}n&&(s.style.color=n),i&&(s.style.backgroundColor=i),e.parentNode.replaceChild(s,e)}})}_sendStartMessage(e,t){console.log("_sendStartMessage called with message:",e,", type:",typeof e),this._sendMessage(e),this.chatContainer.style.display="flex",this.openChatButton.style.display="none"}_sendAsyncStartMessage(e,t,s){console.log("_sendAsyncStartMessage called with message:",e,", type:",typeof e);let o=t.textContent;t.textContent="Processing...",this.openChatButton.innerHTML=`<img src="${this.cdnUrl}/images/ripples.svg" alt="Processing...">`;this._sendMessage(e,e=>{e.chatContainer.style.display="flex",e.openChatButton.style.display="none",e.openChatButton.innerHTML=`<img src="${e.cdnUrl}/images/chat_button.svg" class="open-chat-icon" alt="Chat Button">`,t.textContent=o})}_populateAgentDropdown(){var e;this.agentDropdown&&(this.agentList.forEach(e=>{var t=document.createElement("option");t.value=e.agent_uuid,t.textContent=e.agent_name,this.agentDropdown.appendChild(t)}),1<this.agentList.length)&&(e=localStorage.getItem("selectedAgent"),this.agentDropdown.value=e||this.agentList[0].agent_uuid)}_hideInitialPrompt(){this.shadow.getElementById("defaultbackground")?.remove()}_sendMessage(e,t){console.log("_sendMessage function - message received:",e,", type:",typeof e);let s="";if(void 0!==e)s=String(e).trim();else{if(!this.messageInput)return void console.error("Message input is not available.");s=this.messageInput.value.trim()}s?(this.requestBody.continue=this.continueCheckbox.checked,this.requestBody.context=s,this._appendMessage("user",s,!0),this.messageInput&&(this.messageInput.value=""),this._appendTypingIndicator(),this._setWaitingMessages(),this._fetchAgentResponse(t),this._hideInitialPrompt()):console.log("_sendMessage - userMessage is empty after processing.")}_fetchAgentResponse(t){var e={method:"POST",headers:{"Content-Type":"application/json","X-Auth-Token":this.config.authToken},body:JSON.stringify(this.requestBody)},s=this.config.apiEndpoint;this.isExtraLoggingEnabled&&this._logRequestDetails(s,e),fetch(s,e).then(e=>this._handleResponse(e)).then(e=>this._processResponseData(e,t)).catch(e=>this._handleError(e,t))}_logRequestDetails(e,t,s=!1){this.isExtraLoggingEnabled&&(console.groupCollapsed("API Request Details"),console.log("Request URL:",e),console.log("Request Method:",t.method),console.log("Request Headers:",t.headers),s?console.log("Request Body: FormData (cannot be directly logged)"):console.log("Request Body:",this.requestBody),console.groupEnd())}_handleResponse(e){if(this._removeTypingIndicator(),this.isExtraLoggingEnabled&&this._logResponseDetails(e),e.ok)return e.json();throw this.isExtraLoggingEnabled&&(console.error("HTTP Error Response:",e),console.groupEnd()),new Error("HTTP error! status: "+e.status)}_logResponseDetails(e){this.isExtraLoggingEnabled&&(console.groupCollapsed("API Response Details"),console.log("Response Status:",e.status),console.log("Response Headers:",e.headers))}_processResponseData(e,t){this.isExtraLoggingEnabled&&(console.log("Response Body (JSON):",e),console.groupEnd());var s=e.agent_message||"No response from agent";this.requestBody.key=e.key,this._cacheConversationKey(e.key),this._appendMessage("agent",s,!0),this._clearWaitingMessages(),t?.(this)}_handleError(e,t){t?.(this),this._clearWaitingMessages(),this._removeTypingIndicator(),this.isExtraLoggingEnabled&&this._logErrorDetails(e),console.error("Error:",e),this._appendError("Error getting a response from Loomlay. Please check your connection and try again.")}_logErrorDetails(e){this.isExtraLoggingEnabled&&(console.groupCollapsed("Fetch Error Details"),console.error("Fetch Error:",e),console.groupEnd())}_setWaitingMessages(){this.config.autoResponse&&this.automaticMessagesConfig.forEach(e=>{var t=setTimeout(()=>this._callWithAutomaticMessage(e.message),e.timeout);this.waitingMessagesTimers.push(t)})}_clearWaitingMessages(){Array.isArray(this.waitingMessagesTimers)?(this.waitingMessagesTimers.forEach(e=>clearTimeout(e)),this.waitingMessagesTimers=[]):console.warn("_clearWaitingMessages: waitingMessagesTimers is not an array, skipping clearTimeout."),this._clearAutomaticMessages()}_callWithAutomaticMessage(e){this._clearAutomaticMessages(),this._appendMessage("agent",e,!1,"automatic")}_clearAutomaticMessages(){Array.from(this.chatMessages.childNodes).forEach(e=>{e.id?.startsWith("automatic")&&this.chatMessages.removeChild(e)})}_formatMessage(e){console.log("Formatting message:",e),e=(e=this._replaceWeb3Actions(e)).replace(/<whisper>.*?<\/whisper>/gs,""),e=this._replacePatterns(e),e=this._defaultFormatMessage(e);var t,s=this._extractInstructionBlock(e,"<instructions>","</instructions>");return s&&(t=this._parseInstructionJSON(s.content))?(t=this._createInstructionButtonHTML(t.label,t.actions),this._reconstructMessage(e,s.start,s.end,t)):this._defaultFormatMessage(e)}_extractInstructionBlock(e,t="[instructions|",s="]"){var o,n=e.indexOf(t);return-1===n||-1===(o=e.indexOf(s,n))?null:{content:e.substring(n+t.length,o).trim(),start:n,end:o+s.length}}_parseInstructionJSON(e){try{return JSON.parse(e)}catch(e){return console.error("JSON Parsing Failed:",e),null}}_createInstructionButtonHTML(e,t){var s=document.createElement("button");return s.textContent=e||"Execute Actions",s.className="instruction-button replybutton",s.dataset.actions=JSON.stringify(t),s.outerHTML}_reconstructMessage(e,t,s,o){return e.substring(0,t)+o+e.substring(s+2)}_defaultFormatMessage(e){return console.log("Original message:",e),e=e.replace(/^- (.+?)(?=\n|$)/gm,(e,t)=>(console.log("Replace '- (.+?)(?=\\n|$)' -> <li>$1</li>: ",t),`<li>${t}</li>`)).replace(/^- (.+?)\n/gm,(e,t)=>(console.log("Replace '- (.+?)\\n' -> <li>$1</li>: ",t),`<li>${t}</li>`)).replace(/^(\s*)- (.+?)\n/gm,(e,t,s)=>{t=t.length/2;return console.log("Replace '^(s*)- (.+?)\\n' -> nested <ul> and <li>: ",s),"<ul>".repeat(t)+`<li>${s}</li>`+"</ul>".repeat(t)}).replace(/^(\s*)- (.+?)(?=\n|$)/gm,(e,t,s)=>{t=t.length/2;return console.log("Replace '^(s*)- (.+?)(?=\\n|$)' -> nested <ul> and <li>: ",s),"<ul>".repeat(t)+`<li>${s}</li>`+"</ul>".repeat(t)}).replace(/^(\d+)\. (.+?)\n/gm,(e,t,s)=>(console.log("Replace '^(\\d+)\\. (.+?)\\n' -> <div>$1. $2</div>: ",t,s),`<div>${t}. ${s}</div>`)).replace(/^(\d+)\. (.+?)(?=\n|$)/gm,(e,t,s)=>(console.log("Replace '^(\\d+)\\. (.+?)(?=\\n|$)' -> <div>$1. $2</div>: ",t,s),`<div>${t}. ${s}</div>`)).replace(/^# (.+?)$/gm,(e,t)=>(console.log("Replace '# (.+?)' -> <h1>$1</h1>: ",t),`<h1>${t}</h1>`)).replace(/^## (.+?)$/gm,(e,t)=>(console.log("Replace '## (.+?)' -> <h2>$1</h2>: ",t),`<h2>${t}</h2>`)).replace(/^### (.+?)$/gm,(e,t)=>(console.log("Replace '### (.+?)' -> <h3>$1</h3>: ",t),`<h3>${t}</h3>`)).replace(/^#### (.+?)$/gm,(e,t)=>(console.log("Replace '#### (.+?)' -> <h4>$1</h4>: ",t),`<h4>${t}</h4>`)).replace(/\*\*([^\n:]+?)\*\*:(\n|$)/gm,(e,t)=>(console.log("Replace '\\*\\*([^\n:]+?)\\*\\*:(\\n|$)' -> <strong>$1 :</strong>: ",t),` <strong>${t} :</strong> <br>`)).replace(/\*\*(.+?)\*\*/g,(e,t)=>(console.log("Replace '\\*\\*(.+?)\\*\\*' -> <strong>$1</strong>: ",t),`<strong>${t}</strong>`)).replace(/\*(.+?)\*/g,(e,t)=>(console.log("Replace '\\*(.+?)\\*' -> <em>$1</em>: ",t),`<em>${t}</em>`)).replace(/\n/g,()=>(console.log("Replace '\\n' -> <br>"),"<br>")),console.log("Formatted message:",e),e}_executeInstructions(e){console.log("_executeInstructions called!");let t,s;try{if(t=JSON.parse(e.dataset.actions||"[]"),s=this._generateInstructionKey(e.dataset.actions),!Array.isArray(t))throw new Error("Parsed actions is not an array.")}catch(e){return void console.error("Error parsing actions:",e)}this._storeInstructionState(s,{actions:t,actionIndex:0,status:"pending"}),this.stopAllButton.style.display="block",this._executeActionsSequentially(t,s)}_generateInstructionKey(t){let s=0;for(let e=0;e<t.length;e++){var o=t.charCodeAt(e);s=(s<<5)-s+o,s&=s}return"instructionState_"+s.toString(16)}_storeInstructionState(e,t){localStorage.setItem(e,JSON.stringify(t)),console.log("Instruction state stored for key: "+e,t)}_clearInstructionState(e){localStorage.removeItem(e),console.log("Instruction state cleared for key: "+e)}_resumeAllInstructions(){Object.keys(localStorage).forEach(e=>{var t,s,o,n;e.startsWith("instructionState_")&&(t=localStorage.getItem(e))&&({actions:s,actionIndex:o,status:n}=JSON.parse(t),s&&Array.isArray(s)&&void 0!==o&&"pending"===n?(console.log("Resuming execution for key: "+e),this._executeActionsSequentially(s,e,o)):(console.warn("Invalid or completed instruction state found, clearing: "+t),this._clearInstructionState(e)))})}_executeActionsSequentially(o,n,i=0){o.slice(i).reduce((e,t,s)=>e.then(()=>new Promise(e=>{setTimeout(()=>{if(this.isStopAllRequested)this.stopAllButton.style.display="none",console.log("Stop all requested, halting instruction execution.");else{this.stopAllButton.style.display="block";try{this._performAction(t),this._updateInstructionState(n,i+s+1,o,"pending")}catch(e){console.error("Error executing action: "+JSON.stringify(t),e),this._updateInstructionState(n,i+s+1,o,"failed")}}e()},t.wait||0)})),Promise.resolve()).then(()=>{this.isStopAllRequested||(console.log("Instruction execution completed for key: "+n),this._clearInstructionState(n)),this.stopAllButton.style.display="none"})}_updateInstructionState(e,t,s,o){t>=s.length?this._clearInstructionState(e):this._storeInstructionState(e,{actions:s,actionIndex:t,status:o})}_performAction(e){if("browse"===e.type)switch(e.action){case"navigate":this._navigateTo(e.target);break;case"scroll":this._scrollToElement(e.target,e.scroll_behavior||"smooth");break;case"highlight":this._highlightElement(e.target,e.options);break;case"click":this._clickElement(e.target);break;case"fillForm":this._fillForm(e.target,e.value);break;case"tooltip":this._showTooltip(e.target,e.value);break;case"reload":this._reloadPage();break;case"back":this._goBack();break;case"click_x_y":this._clickAtCoordinates(e);break;case"send_screenshot":this._sendScreenshotAction(e);break;default:console.warn("Unknown action:",e)}}_getShadowElement(e){if(e&&"string"==typeof e){var t,s=document.querySelector(e);if(s)return s;for(t of document.querySelectorAll("*"))if(t.shadowRoot){var o=t.shadowRoot.querySelector(e);if(o)return o}}else console.warn("Invalid selector:",e);return null}_reloadPage(){console.log("Page reload triggered"),window.location.reload()}_navigateTo(t,e={}){window.history.pushState?(window.history.pushState({},"",t),console.log("Navigated (SPA mode) to:",t,"Options:",e),setTimeout(()=>{var e=document.querySelector(t);e&&e.scrollIntoView({behavior:"smooth",block:"start"})},100)):window.location.href=t}_scrollToElement(e,t="smooth",s){var o=this._getShadowElement(e);o?o.scrollIntoView({behavior:t,block:"center"}):console.warn(`Element with selector "${e}" not found for scroll.`)}_highlightElement(e,t=0){this.highlightedElement&&this._removeHighlight();var s=this._getShadowElement(e);s?((this.highlightedElement=s).classList.add("highlighted"),setTimeout(()=>this._removeHighlight(),3e3)):console.warn(`Element with selector "${e}" not found for highlight.`)}_removeHighlight(){this.highlightedElement&&(this.highlightedElement.classList.remove("highlighted"),this.highlightedElement=null)}_showTooltip(e,o){var n=this._getShadowElement(e);if(n){let e=document.createElement("div");e.className="ai-tooltip",e.innerText=o,document.body.appendChild(e);var o=n.getBoundingClientRect(),n=e.offsetWidth,i=e.offsetHeight;let t=o.left+window.scrollX,s=o.top+window.scrollY-i-10;(t=t+n>window.innerWidth?window.innerWidth-n-10:t)<0&&(t=10),s<0&&(s=o.bottom+window.scrollY+10),e.style.left=t+"px",e.style.top=s+"px",setTimeout(()=>e.classList.add("show"),50),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>e.remove(),300)},3e3)}else console.warn("Element not found for tooltip: "+e)}_fillForm(e,t){var s=this._getShadowElement(e);s?(s.value=t,s.dispatchEvent(new Event("input",{bubbles:!0})),console.log(`Filled input ${e} with value: `+t)):console.warn("Input field not found: "+e)}_clickElement(e){var t=this._getShadowElement(e);t?(t.click(),console.log("Clicked on element: "+e)):console.warn("Element not found for click: "+e)}_showClickFeedback(e,t){let s=document.createElement("div");s.className="click-feedback",s.style.left=e+"px",s.style.top=t+"px",document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},500)}_clickAtCoordinates(e){let i=e.x,a=e.y;var t=!1!==e.relative;console.log("🟢 Action received: "+JSON.stringify(e)),console.log(`🟢 Current scroll position: X=${window.scrollX}, Y=`+window.scrollY),t||(console.log("🔄 Converting document-relative coordinates to viewport-relative."),i=e.x-window.scrollX,a=e.y-window.scrollY),console.log(`📌 Final Viewport Coordinates: X=${i}, Y=`+a),"number"!=typeof i||"number"!=typeof a?console.warn("❌ Invalid coordinates for click_x_y action."):(window.scrollTo({top:e.y-window.innerHeight/2,behavior:"smooth"}),setTimeout(()=>{var e,t,s=window.scrollX,o=window.scrollY,s=(console.log(`🟢 New scroll position: X=${s}, Y=`+o),i-s),o=a-o;console.log(`📍 Adjusted Viewport Coordinates after scroll: X=${s}, Y=`+o);let n=document.elementFromPoint(s,o);console.log("🔍 Element found after scrolling:",n),n?(e=n,t=e.getBoundingClientRect(),document.elementFromPoint(t.left+t.width/2,t.top+t.height/2)!==e?console.warn("⚠️ The element is blocked by another element."):(n.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{var e=n.getBoundingClientRect(),t=e.left+e.width/2,e=e.top+e.height/2,t=(console.log(`✅ Clicking at: X=${t}, Y=`+e),new MouseEvent("click",{clientX:t,clientY:e,bubbles:!0,cancelable:!0}));n.dispatchEvent(t),console.log("✅ Clicked element:",n)},500))):console.warn(`⚠️ No element found at viewport coordinates: X=${s}, Y=`+o)},1e3))}_goBack(){console.log("Navigating back in history"),window.history.back()}_displayScreenshotInChat(e){var t=document.createElement("img");t.src=e,t.style.maxWidth="100%",t.style.height="auto",this._clearAutomaticMessages(),this._appendMessage("agent",t.outerHTML,!1)}_dataURLtoFile(e,t){let s=e.split(","),o=s[0].match(/:(.*?);/)[1],n=atob(s[1]),i=n.length,a=new Uint8Array(i);for(;i--;)a[i]=n.charCodeAt(i);return new File([a],t,{type:o})}_sendFileMessage(e,t){var s,o=new FormData;for(s in o.append("file",e),this.requestBody)"context"!==s&&o.append(s,this.requestBody[s]);o.append("context",t),o.append("continue",this.continueCheckbox.checked);e={method:"POST",headers:{"X-Auth-Token":this.config.authToken},body:o},t=this.config.apiEndpoint;this.isExtraLoggingEnabled&&this._logRequestDetails(t,e,!0),fetch(t,e).then(e=>this._handleResponse(e)).then(e=>this._processResponseData(e,null)).catch(e=>this._handleError(e,null))}async _sendScreenshotAction(e){let t=this._getShadowElement(e.target);e=e.target||"body";if((t=t||document.querySelector(e))||(t=document.body,console.warn(`Target element with selector "${e}" not found in shadow or light DOM. Falling back to body.`)),t){this._appendMessage("agent","Preparing screenshot...",!1,"automatic");try{void 0===window.html2canvas&&await this._loadScript("https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js");var s=(await window.html2canvas(t)).toDataURL("image/png"),o=(this._displayScreenshotInChat(s),this._dataURLtoFile(s,"screenshot.png"));this._sendFileMessage(o,"user screen is sent")}catch(e){console.error("Error capturing screenshot:",e),this._clearAutomaticMessages(),this._appendError("Failed to capture screenshot.")}}else console.error("Critical error: document.body not found for screenshot!")}_appendMessage(e,t,s,o){console.log("_appendMessage - sender:",e,", message:",t,", type:",typeof t);t=String(t),s&&this._cacheMessage(e,t),s=document.createElement("div"),s.className=`message-container ${e}-message-container`,o&&(s.id=o+"_container"),o=document.createElement("div");o.className=`message ${e}-message`,o.innerHTML=this._formatMessage(t),s.appendChild(o),this.chatMessages.appendChild(s),this._attachWeb3ButtonListeners(o),setTimeout(()=>{this._scrollToChatBottom()},0)}_cacheMessage(e,t){var s="cachedConversation_"+this.config.agentUUID,o=JSON.parse(localStorage.getItem(s))||{key:null,messages:[]};o.messages.push({sender:e,message:t}),localStorage.setItem(s,JSON.stringify(o))}_cacheConversationKey(e){var t="cachedConversation_"+this.config.agentUUID,s=JSON.parse(localStorage.getItem(t))||{key:null,messages:[]};s.key=e,localStorage.setItem(t,JSON.stringify(s))}_removeConversationCache(){localStorage.removeItem("cachedConversation_"+this.config.agentUUID),this.requestBody=this._getDefaultRequestBodyConfig(),this._updateRequestContext(),console.log("greetings - ",this.greetingMessage),this.greetingMessage?(this.chatMessages.innerHTML="",console.log("Greeting msg :",this.greetingMessage),this._appendMessage("agent",this.greetingMessage,!0),this._hideInitialPrompt()):this.chatMessages.innerHTML=`<div id="defaultbackground" class="default-background"><img src="${this.cdnUrl}/images/default.svg" alt="Default Background"><br/><br/></div>`}_getDefaultRequestBodyConfig(){return{agent_uuid:this.config.agentUUID,context:null,extra_context:null,continue:!0,key:null,extra_params:null}}navigate(e){window.location.href=e}createElement(e,t,s,o){let n;if("btn"===e)(n=document.createElement("button")).className="replybutton";else{if("link"!==e)return console.error('Invalid type. Use "btn" for button or "link" for anchor tag.'),"";(n=document.createElement("span")).href="#",n.className="replylink"}return n.textContent=o,"prompt"===t?(n.setAttribute("data-context",s),n.setAttribute("data-action","prompt")):"open-new"===t?(n.setAttribute("data-url",s),n.setAttribute("data-action","open-new")):"open-current"===t&&(n.setAttribute("data-url",s),n.setAttribute("data-action","open-current")),n.outerHTML}_replaceWeb3Actions(e){let t=e;return t=(t=t.replace(/<swap>(.*?)<\/swap>/g,(t,e)=>{try{var s=JSON.parse(e);return this._createWeb3ButtonHTML("swap",s)}catch(e){return console.error("Error parsing JSON for swap action:",e),t}})).replace(/<send>(.*?)<\/send>/g,(t,e)=>{try{var s=JSON.parse(e);return this._createWeb3ButtonHTML("send",s)}catch(e){return console.error("Error parsing JSON for send action:",e),t}})}_createWeb3ButtonHTML(e,t){var s=t.label||e.toUpperCase()+" Action";return`<button class="web3-button replybutton" id="${`web3-${e}-button-`+Date.now()}" data-action-type="${e}" data-action-params='${JSON.stringify(t)}'>${s}</button>`}_attachWeb3ButtonListeners(e){e.querySelectorAll(".web3-button").forEach(o=>{o.addEventListener("click",async e=>{var t=o.dataset.actionType,s=JSON.parse(o.dataset.actionParams);window.ethereum?"swap"===t?this._handleSwapAction(s):"send"===t&&this._handleSendAction(s):alert("Please install MetaMask or a compatible Web3 wallet!")})})}async _handleSwapAction(e){if(window.ethereum)try{var t={from:(await window.ethereum.request({method:"eth_requestAccounts"}))[0],to:e.to,data:e.data,value:e.value},s=await window.ethereum.request({method:"eth_sendTransaction",params:[t]});console.log("Swap Transaction Hash:",s),alert(`Swap Transaction Successful!
Transaction Hash: `+s)}catch(e){console.error("Swap Error:",e),alert(`Swap Failed!
`+e.message)}else alert("Web3 wallet not detected!")}async _handleSendAction(e){if(window.ethereum)try{var t={from:(await window.ethereum.request({method:"eth_requestAccounts"}))[0],to:e.to,data:e.data,value:e.value},s=await window.ethereum.request({method:"eth_sendTransaction",params:[t]});console.log("Send Transaction Hash:",s),alert(`Send Transaction Successful!
Transaction Hash: `+s)}catch(e){console.error("Send Error:",e),alert(`Send Failed!
`+e.message)}else alert("Web3 wallet not detected!")}_replacePatterns(e){return e.replace(/\[(btn|link)\|(.*?)\|(.*?)\|(.*?)\]/g,(e,t,s,o,n)=>this.createElement(t,s,o,n)||e)}_loadConversationCache(){var e="cachedConversation_"+this.config.agentUUID,e=JSON.parse(localStorage.getItem(e));e?.messages?.length?(this.requestBody.key=e.key,this._hideInitialPrompt(),e.messages.forEach(e=>{this._appendMessage(e.sender,e.message,!1)}),this._scrollToChatBottom()):(this.chatMessages.innerHTML=`<div id="defaultbackground" class="default-background"><img src="${this.cdnUrl}/images/default.svg" alt="Default Background"><br/><br/></div>`,this.greetingMessage&&(console.log("Greeting msg :",this.greetingMessage),this._appendMessage("agent",this.greetingMessage,!0),this._hideInitialPrompt()))}_appendTypingIndicator(){var e=document.createElement("div"),t=(e.className="message-container agent-message-container agent-typing-message",e.id="agent-typing-message-container",document.createElement("div"));t.className="message agent-message",t.innerHTML='<div id="agent-typing-dots" class="agent-typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>',e.appendChild(t),this.chatMessages.appendChild(e),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}_removeTypingIndicator(){this.chatMessages.querySelector("#agent-typing-message-container")?.remove()}_appendError(e){this._removeError(),this._removeTypingIndicator();var t=document.createElement("div"),s=(t.className="message-container agent-message-container error-message",document.createElement("div"));s.className="message agent-message",s.textContent=e,t.appendChild(s),this.chatMessages.appendChild(t),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}_removeError(){this.chatMessages.querySelector(".error-message")?.remove()}}customElements.define("loomlay-chat",e)})();